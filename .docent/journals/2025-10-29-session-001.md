# Session: Fix Failing CI/CD Tests

**Date:** 2025-10-29
**Status:** Completed
**Duration:** ~15 minutes
**Commit:** 483ad5a

## Objective

Investigate and fix failing CI/CD workflows on main branch.

## Investigation

Ran docent runbook `ci-health-check` to diagnose the issue:

```bash
gh run list --limit 10
gh run view 18919384740
gh run view 18919384740 --log-failed
```

Both Ubuntu and macOS test jobs were failing at "Run tests" step with TypeScript compilation errors.

## Root Causes Identified

### 1. Import Path Changes

Tests were importing from the old `src/lib/*` directory structure, but modules had been reorganized into `src/core/*`:

- `src/lib/config` → `src/core/config`
- `src/lib/template` → `src/core/template`
- `src/lib/context` → `src/core/context`

**Error:** `Cannot find module '../src/lib/config' or its corresponding type declarations`

### 2. Configuration Defaults Changed

The default configuration values were updated as part of the 2.0 architecture:

- Default root: `docs` → `.docent`
- Journal path: `.journal` → `journals`

Test expectations needed updating to match these new defaults.

### 3. Template Naming Convention

Template files were renamed to remove the `-template` suffix:

- `adr-template.md` → `adr.md`
- `rfc-template.md` → `rfc.md`
- etc.

ResourceHandler and test expectations were still looking for old filenames.

## Changes Made

Fixed 5 files:

1. `test/config.test.ts` - Updated config default expectations
2. `test/unit/lib/template.test.ts` - Fixed import path from `src/lib` to `src/core`
3. `test/unit/mcp/resources/handler.test.ts` - Fixed import path and template expectations
4. `src/mcp/resources/handler.ts` - Updated template filename handling (removed `-template` suffix)
5. `src/mcp/tools/get-template.ts` - Updated template filename mappings

## Results

- ✅ All 47 tests passing locally
- ✅ CI workflow successful on commit 483ad5a
- ✅ Both Ubuntu and macOS builds passing

## Lessons Learned

When performing architectural reorganizations:

1. Update all import paths across both source and test files
2. Update test expectations to match new defaults/conventions
3. Ensure ResourceHandler and template tooling are synchronized on naming conventions
4. Run full test suite locally before pushing to catch these issues early
5. Consider adding a linting rule or script to detect cross-boundary imports

## Next Steps

- Monitor CI for any flaky tests
- Consider documenting the new module structure in architecture docs
